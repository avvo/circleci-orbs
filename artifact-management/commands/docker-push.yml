description: Push built Docker images to repo host(s)
parameters:
  docker_repo_host:
    description: The private Docker repo to which images should be pushed
    type: env_var_name
    default: AVVO_DOCKER_REPO_HOST
steps:
  - run:
      name: Publish tagged image
      command: |-
        set -x

        TAG=avvo/$CIRCLE_PROJECT_REPONAME:$CIRCLE_SHA1

        # Log in to Dockerhub and push
        if [ -n "$DOCKER_USER" ]; then
          docker login -u $DOCKER_USER -p $DOCKER_PASS
          docker push $TAG
        fi

        # Push to private Docker repo
        if [ -n "$AVVO_DOCKER_REPO_HOST" ]; then
          docker tag $TAG $AVVO_DOCKER_REPO_HOST/$TAG
          docker login -u $AVVO_DOCKER_REPO_USER -p $AVVO_DOCKER_REPO_PASS $AVVO_DOCKER_REPO_HOST
          docker push $AVVO_DOCKER_REPO_HOST/$TAG
        fi
